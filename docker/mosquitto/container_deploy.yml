- name: Deploying Mosquitto MQTT Container
  hosts: all
  become: true
  collections:
    - community.docker

  vars:
    fqdn: "{{fqdn}}"
    container_name: "{{container_name}}"
    dedicated_ip: "{{dedicated_ip}}"

  tasks:
    - name: Ensure mosquitto config volume exists
      community.docker.docker_volume:
        name: mosquitto_config
        state: present

    - name: Ensure mosquitto data volume exists
      community.docker.docker_volume:
        name: mosquitto_data
        state: present

    - name: Ensure mosquitto config dir exists on host
      ansible.builtin.file:
        path: /var/lib/docker/volumes/mosquitto_config/_data
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Ensure mosquitto data dir exists on host
      ansible.builtin.file:
        path: /var/lib/docker/volumes/mosquitto_data/_data
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Ensure letsencrypt volume exists
      community.docker.docker_volume:
       name: letsencrypt
       state: present

    - name: Deploy mosquitto.conf into config volume
      ansible.builtin.copy:
        dest: /var/lib/docker/volumes/mosquitto_config/_data/mosquitto.conf
        content: |
          # Mosquitto config - allows anonymous connections, MQTT and WebSockets
          persistence true
          persistence_location /mosquitto/data/
          log_dest stdout

          # Plain MQTT listener
          listener 1883
          protocol mqtt

          # MQTT over TLS
          listener 8883
          protocol mqtt
          certfile /etc/letsencrypt/live/{{ fqdn }}/fullchain.pem
          keyfile /etc/letsencrypt/live/{{ fqdn }}/privkey.pem

          # Websockets listener (secure)
          listener 8083
          protocol websockets
          certfile /etc/letsencrypt/live/{{ fqdn }}/fullchain.pem
          keyfile /etc/letsencrypt/live/{{ fqdn }}/privkey.pem

          # Allow all connections
          allow_anonymous true

        owner: root
        group: root
        mode: '755'
      become: true

    - name: Copy Let's Encrypt cert and key into mosquitto config volume
      ansible.builtin.copy:
        src: /var/lib/docker/volumes/letsencrypt/_data/live/{{ fqdn }}/fullchain.pem
        dest: /var/lib/docker/volumes/mosquitto_config/_data/fullchain.pem
        owner: root
        group: root
        mode: '0644'
      become: true

    - name: Copy Let's Encrypt private key into mosquitto config volume
      ansible.builtin.copy:
        src: /var/lib/docker/volumes/letsencrypt/_data/live/{{ fqdn }}/privkey.pem
        dest: /var/lib/docker/volumes/mosquitto_config/_data/privkey.pem
        owner: root
        group: root
        mode: '0644'
      become: true

    - name: Remove existing mosquitto container
      community.docker.docker_container:
        name: "{{container_name}}"
        state: absent

    - name: Deploy Mosquitto MQTT container
      community.docker.docker_container:
        name: "{{container_name}}"
        image: eclipse-mosquitto:2.0
        pull: yes
        state: started
        restart_policy: unless-stopped
        recreate: true
        volumes:
          - mosquitto_config:/mosquitto/config
          - mosquitto_data:/mosquitto/data
          - letsencrypt:/etc/letsencrypt:ro
        networks:
          - name: VLAN26
            ipv4_address: "{{ dedicated_ip | default(omit) }}"
