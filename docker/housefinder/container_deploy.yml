- name: Deploying Container
  hosts: all
  become: true
  collections:
    - community.docker

  vars:
    fqdn: "{{fqdn}}"
    container_name: "{{container_name}}"
    dedicated_ip: "{{dedicated_ip}}"
    googlemaps_api_key: "{{ googlemaps_api_key | default('') }}"
    googlemaps_map_id: "{{ googlemaps_map_id | default(omit) }}"
    mqtt_host: "{{ mqtt_host | default(omit) }}"
    mqtt_ca_cert_path : "{{ mqtt_ca_cert_path | default(omit) }}"
    TELEGRAM_BOT_TOKEN: "{{ TELEGRAM_BOT_TOKEN | default(omit) }}"
    TELEGRAM_CHAT_ID: "{{ TELEGRAM_CHAT_ID | default(omit) }}"

  tasks:

    - name: Creates/Ensures data volume exists
      community.docker.docker_volume:
       name: "{{container_name}}_data"
       state: present

    - name: Checks Host folder exists
      ansible.builtin.file:
        path: /var/lib/docker/volumes/{{container_name}}_data/_data
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create internal Docker network for housefinder
      community.docker.docker_network:
        name: housefinder_net
        state: present
        driver: bridge

    - name: Remove existing frontend container (if present)
      community.docker.docker_container:
        name: "{{ container_name }}-frontend"
        state: absent

    - name: Remove existing backend container (if present)
      community.docker.docker_container:
        name: "{{ container_name }}-backend"
        state: absent
    
    - name: Remove existing message bot container
      community.docker.docker_container:
        name: "{{ container_name }}-messagebot"
        state: absent      

    - name: Remove existing rejection scanner container
      community.docker.docker_container:
        name: "{{ container_name }}-rejection-scanner"
        state: absent     
    
    - name: Run backend job (one-shot)
      community.docker.docker_container:
        name: "{{ container_name }}-backend"
        image: ghcr.io/tunsworthy/housefinder_backend:latest
        pull: yes
        state: started
        recreate: true
        auto_remove: false   # keep container for logs/debugging
        env:
          GOOGLE_API_KEY: "{{ googlemaps_api_key | default(omit) }}"
          MQTT_HOST: "{{ mqtt_host | default(omit) }}"
          MQTT_CA_CERT_PATH: "{{ mqtt_ca_cert_path | default(omit) }}"
          MQTT_TOPIC_PREFIX : "{{container_name}}"
        volumes:
          - "{{ container_name }}_data:/data"
          - letsencrypt:/etc/letsencrypt:ro
    
    - name: Run Message Bot
      community.docker.docker_container:
        name: "{{ container_name }}-messagebot"
        image: ghcr.io/tunsworthy/housefinder_messagebot:latest
        pull: yes
        state: started
        restart_policy: always
        recreate: true
        auto_remove: false   # keep container for logs/debugging
        env:
          TELEGRAM_BOT_TOKEN: "{{ TELEGRAM_BOT_TOKEN | default(omit) }}"
          TELEGRAM_CHAT_ID: "{{ TELEGRAM_CHAT_ID | default(omit) }}"
          FRONTEND_URL: "https://{{ fqdn }}"
          MQTT_HOST: "{{ mqtt_host | default(omit) }}"
          MQTT_CA_CERT_PATH: "{{ mqtt_ca_cert_path | default(omit) }}"
          MQTT_TOPIC_PREFIX : "{{container_name}}"
          MQTT_CLIENT_ID : "{{container_name}}-messagebot"
          MQTT_PORT: "{{ mqtt_port | default('8883') }}" 

    - name: Run Rejection Scanner (One-shot)
      community.docker.docker_container:
        name: "{{ container_name }}-rejection-scanner"
        image: ghcr.io/tunsworthy/housefinder_rejection_scanner:latest
        pull: yes
        state: absent
        restart_policy: "no"  # One-shot container, exits after completion
        recreate: true
        auto_remove: false
        detach: false  # Wait for container to complete
        env:
          DATA_DIR: "/data"
          MQTT_HOST: "{{ mqtt_host | default(omit) }}"
          MQTT_PORT: "{{ mqtt_port | default('8883') }}"
          MQTT_CA_CERT_PATH: "{{ mqtt_ca_cert_path | default(omit) }}"
          MQTT_TOPIC_PREFIX: "{{ container_name }}"
        volumes:
          - "{{ container_name }}_data:/data"

    - name: Ensure letsencrypt volume exists
      community.docker.docker_volume:
       name: letsencrypt
       state: present

    - name: Ensure nginx config directory exists on data volume
      ansible.builtin.file:
        path: /var/lib/docker/volumes/{{container_name}}_data/_data/nginx
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Deploy nginx config for housefinder
      ansible.builtin.copy:
        dest: /var/lib/docker/volumes/{{container_name}}_data/_data/nginx/housefinder.conf
        content: |
          server {
            listen 80;
            server_name {{ fqdn }};
            return 301 https://$host$request_uri;
          }

          server {
            listen 443 ssl;
            server_name {{ fqdn }};

            ssl_certificate /etc/letsencrypt/live/{{ fqdn }}/fullchain.pem;
            ssl_certificate_key /etc/letsencrypt/live/{{ fqdn }}/privkey.pem;
            ssl_protocols TLSv1.2 TLSv1.3;

            location / {
              proxy_pass http://{{ container_name }}-frontend:8080;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
            }
          }
        owner: root
        group: root
        mode: '0644'

    - name: Remove existing nginx container
      community.docker.docker_container:
        name: "{{ container_name }}-nginx"
        state: absent

    - name: Deploy nginx reverse-proxy (external IP on VLAN26)
      community.docker.docker_container:
        name: "{{ container_name }}-nginx"
        image: nginx:stable
        pull: yes
        state: started
        restart_policy: unless-stopped
        recreate: true
        volumes:
          - "/var/lib/docker/volumes/{{ container_name }}_data/_data/nginx:/etc/nginx/conf.d:ro"
          - letsencrypt:/etc/letsencrypt:ro
        networks:
          - name: VLAN26
            ipv4_address: "{{ dedicated_ip | default(omit) }}"
          - name: housefinder_net

    - name: Deploy Container
      community.docker.docker_container:
        name: "{{ container_name }}-frontend"
        image: ghcr.io/tunsworthy/housefinder_frontend:latest
        pull: yes
        state: started
        restart_policy: unless-stopped
        recreate: true
        env:
          MAPS_API_KEY: "{{ googlemaps_api_key | default(omit) }}"
          MAPS_MAP_ID : "{{ googlemaps_map_id| default(omit) }}"
          MQTT_HOST: "{{ mqtt_host | default(omit) }}"
          MQTT_CA_CERT_PATH: "{{ mqtt_ca_cert_path | default(omit) }}"
        volumes:
          - "{{ container_name }}_data:/data"
        networks:
          - name: housefinder_net

    - name: Schedule backend job to run every 2 hours
      ansible.builtin.cron:
        name: "{{ container_name }}-backend"
        minute: "0"
        hour: "*/2"
        job: "docker start {{ container_name }}-backend"
        state: present
        user: root

    - name: Schedule rejection scanner to run every 2 hours (5 min after backend)
      ansible.builtin.cron:
        name: "{{ container_name }}-rejection-scanner"
        minute: "5"
        hour: "*/2"
        job: "docker start {{ container_name }}-rejection-scanner"
        state: absent
        user: root

    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: /var/backups/housefinder
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create votes.json backup script
      ansible.builtin.copy:
        dest: /usr/local/bin/backup-{{ container_name }}-votes.sh
        content: |
          #!/bin/bash
          BACKUP_DIR="/var/backups/{{ container_name }}"
          SOURCE_FILE="/var/lib/docker/volumes/{{ container_name }}_data/_data/votes.json"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # Backup with timestamp
          if [ -f "$SOURCE_FILE" ]; then
            cp "$SOURCE_FILE" "$BACKUP_DIR/votes_$TIMESTAMP.json"
            echo "$(date): Backup created: votes_$TIMESTAMP.json" >> "$BACKUP_DIR/backup.log"
          else
            echo "$(date): Source file not found: $SOURCE_FILE" >> "$BACKUP_DIR/backup.log"
          fi
          
          # Retain only last 48 backups (~2 days at 15min intervals)
          find "$BACKUP_DIR" -name "votes_*.json" -type f | sort -r | tail -n +49 | xargs -r rm
        owner: root
        group: root
        mode: '0755'

    - name: Schedule votes.json backup every 15 minutes
      ansible.builtin.cron:
        name: "housefinder-votes-backup"
        minute: "*/15"
        hour: "*"
        job: "/usr/local/bin/backup-{{ container_name }}-votes.sh"
        state: present
        user: root

