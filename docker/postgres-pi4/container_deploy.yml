- name: Deploying Postgres (Pi4)
  hosts: all
  become: true
  collections:
    - community.docker

  vars:
    fqdn: "{{ fqdn | default('postgres.local') }}"
    container_name: "{{ name | default('postgres') }}"
    dedicated_ip: "{{ dedicated_ip | default(omit) }}"

  tasks:

    - name: Ensure Postgres data volume exists
      community.docker.docker_volume:
        name: postgres_data
        state: present

    - name: Ensure internal databases network exists
      community.docker.docker_network:
        name: databases
        state: present
        driver: bridge

    - name: Ensure letsencrypt volume exists
      community.docker.docker_volume:
       name: letsencrypt
       state: present

    - name: Template init SQL into postgres PGDATA subdirectory (renders password variable)
      ansible.builtin.template:
        src: init_db.sql
        dest: /var/lib/docker/volumes/postgres_data/_data/init_db.sql
        owner: root
        group: root
        mode: '0644'

    - name: Ensure Postgres certs volume exists
      community.docker.docker_volume:
        name: postgres_certs
        state: present

    - name: Stat letsencrypt fullchain.pem
      ansible.builtin.stat:
        path: "/var/lib/docker/volumes/letsencrypt/_data/live/{{ fqdn }}/fullchain.pem"
      register: lets_encrypt_cert
      when: ssl | default(false) and use_letsencrypt | default(false)

    - name: Copy fullchain.pem into `postgres_certs` volume
      ansible.builtin.copy:
        src: "/var/lib/docker/volumes/letsencrypt/_data/live/{{ fqdn}}/fullchain.pem"
        dest: /var/lib/docker/volumes/postgres_certs/_data/server.crt
        mode: '0644'
        owner: root
        group: root
      become: true
      

    - name: Copy privkey.pem into `postgres_certs` volume
      ansible.builtin.copy:
        src: "/var/lib/docker/volumes/letsencrypt/_data/live/{{ fqdn }}/privkey.pem"
        dest: /var/lib/docker/volumes/postgres_certs/_data/server.key
        mode: '0600'
        owner: root
        group: root
      become: true
      

    - name: Chown cert files in `postgres_certs` to postgres uid 999
      ansible.builtin.command: chown 999:999 /var/lib/docker/volumes/postgres_certs/_data/server.crt /var/lib/docker/volumes/postgres_certs/_data/server.key
      become: true
      

    - name: Template postgres SSL SQL into PGDATA initdb dir
      ansible.builtin.template:
        src: postgres_ssl.sql
        dest: /var/lib/docker/volumes/postgres_data/_data/postgres_ssl.sql
        mode: '0644'
      when: ssl | default(false)

    - name: Check whether Postgres PGDATA subdirectory is already initialized
      ansible.builtin.find:
        paths: /var/lib/docker/volumes/postgres_data/_data/database
        file_type: any
        recurse: no
      register: pgdata_files

      
    - name: Remove existing Postgres container if present
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent

    - name: Deploy Postgres container
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: postgres:14
        pull: yes
        state: started
        restart_policy: unless-stopped
        recreate: true
        env:
          POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
          POSTGRES_USER: "${POSTGRES_USER}"
          POSTGRES_DB: "${POSTGRES_DB}"
          PGDATA: /var/lib/postgresql/data/database
        volumes:
          - postgres_data:/var/lib/postgresql/data
          - postgres_certs:/var/lib/postgresql/certs:ro
        networks:
          - name: databases
            # internal network only; no dedicated IP assigned

    - name: If PGDATA subdir was empty and letsencrypt certs exist, copy certs now and restart container
      block:
        - name: Copy fullchain.pem into PGDATA after init
          ansible.builtin.copy:
            src: "/var/lib/docker/volumes/letsencrypt/_data/live/{{ fqdn }}/fullchain.pem"
            dest: /var/lib/docker/volumes/postgres_certs/_data/server.crt
            mode: '0644'
            owner: root
            group: root

        - name: Copy privkey.pem into PGDATA after init
          ansible.builtin.copy:
            src: "/var/lib/docker/volumes/letsencrypt/_data/live/{{ fqdn }}/privkey.pem"
            dest: /var/lib/docker/volumes/postgres_certs/_data/server.key
            mode: '0600'
            owner: root
            group: root

        - name: Chown cert files in postgres_certs to postgres uid 999
          ansible.builtin.command: chown 999:999 /var/lib/docker/volumes/postgres_certs/_data/server.crt /var/lib/docker/volumes/postgres_certs/_data/server.key

        - name: Restart Postgres container to pick up SSL certs
          ansible.builtin.command: docker restart {{ container_name }}

    - name: Stat init SQL inside data volume
      ansible.builtin.stat:
        path: /var/lib/docker/volumes/postgres_data/_data/init_db.sql
      register: init_sql_exists

    - name: Stat postgres_ssl SQL inside data volume
      ansible.builtin.stat:
        path: /var/lib/docker/volumes/postgres_data/_data/postgres_ssl.sql
      register: ssl_sql_exists

    - name: Wait for Postgres container to be running and ready
      community.docker.docker_container_info:
        name: "{{ container_name }}"
      register: pg_container_info
      retries: 24
      delay: 5
      until: >
        pg_container_info.container is defined and
        pg_container_info.container.State.Running and
        pg_container_info.container.State.Status == 'running'
    - pause:
      seconds: 5
      
    - name: Wait for Postgres to be ready
      ansible.builtin.command: >
        docker exec {{ container_name }}
        pg_isready -U {{ postgres_user }} -d {{ postgres_db }}
      register: pg_ready
      retries: 24
      delay: 5
      until: pg_ready.rc == 0

    - name: Execute postgres_ssl.sql inside container (if present)
      ansible.builtin.command: docker exec -i {{ container_name }} psql -U ${POSTGRES_USER} -d ${POSTGRES_DB} -f /var/lib/postgresql/data/postgres_ssl.sql
      when: ssl_sql_exists.stat.exists

    - name: Execute init_db.sql inside container (if present)
      ansible.builtin.command: docker exec -i {{ container_name }} psql -U ${POSTGRES_USER} -d ${POSTGRES_DB} -f /var/lib/postgresql/data/init_db.sql
      when: init_sql_exists.stat.exists
