---
- name: Validate VLAN configuration
  hosts: all
  become: true
  gather_facts: true
  vars:
    vlan_template_src: "vlan-config-{{ runner | lower }}.yaml.j2"
    vlan_interfaces:
      - vlan22
      - vlan23
      - vlan24
      - vlan25
      - vlan26
    expected_vlan24_ip: "10.2.4.20"
    expected_gateway: "10.2.4.1"
    dns_test_host: "google.com"

  tasks:
    - name: Render VLAN config template to local temp file
      ansible.builtin.template:
        src: "{{ vlan_template_src }}"
        dest: "/tmp/rendered-vlan.yaml"
        mode: '0644'

    - name: Read rendered VLAN config
      ansible.builtin.slurp:
      src: /tmp/rendered-vlan.yaml
      register: rendered_vlan_file

    - name: Parse YAML from rendered template
      set_fact:
       parsed_vlan_config: "{{ rendered_vlan_file['content'] | b64decode | from_yaml }}"

    - name: Extract expected VLAN interfaces
      set_fact:
        expected_vlan_interfaces: "{{ parsed_vlan_config.network.vlans.keys() | list }}"
        expected_vlan24_ip: "{{ parsed_vlan_config.network.vlans.vlan24.addresses[0] | default('') }}"
        expected_gateway: "{{ parsed_vlan_config.network.vlans.vlan24.gateway4 | default('') }}"
        expected_nameservers: "{{ parsed_vlan_config.network.vlans.vlan24.nameservers.addresses | default([]) }}"
    
    - name: Check that VLAN interfaces exist
      ansible.builtin.command: ip link show {{ item }}
      register: vlan_links
      changed_when: false
      failed_when: vlan_links.rc != 0
      loop: "{{ expected_vlan_interfaces }}"