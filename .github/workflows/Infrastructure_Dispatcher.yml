name: Infrastructure Dispatcher
on:
  workflow_dispatch:
    inputs:
      host:
        description: 'Target Host'
        required: true
        default: 'pi3'
      setup_type:
        description: 'Which setup to run'
        required: true
        default: 'network'
        type: choice
        options:
          - host network
          - docker install
          - docker network
          - host OS Update
          - ssh create-user
          - ssh setup-keys
          - all
jobs:
  dispatch:
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.set-vars.outputs.env }}
      runner: ${{ steps.set-vars.outputs.runner }}
    env:
      BASE_DIR: 'infrastructure/host'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install yq
        run: sudo apt-get install -y yq

      - name: Read config
        id: set-vars
        run: |
          cd $BASE_DIR
          HOST="${{ github.event.inputs.host }}"
          ENV=$(yq -r ".hosts.${HOST}.environment" hosts-config.yml)
          RUNNER=$(yq -r ".hosts.${HOST}.runner" hosts-config.yml)

          if [[ "$ENV" == "null" || "$RUNNER" == "null" ]]; then
            echo "Unknown host: $HOST"
            exit 1
          fi

          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "runner=$RUNNER" >> $GITHUB_OUTPUT

  call_network:
    if: ${{ github.event.inputs.setup_type == 'host network' || github.event.inputs.setup_type == 'all' }}
    uses: ./.github/workflows/Network_Setup.yml
    with:
      host: ${{ github.event.inputs.host }}
      environment: ${{ needs.dispatch.outputs.env }}
      runs_on: ${{ needs.dispatch.outputs.runner }}
    needs: dispatch

  call_docker:
    if: ${{ github.event.inputs.setup_type == 'docker install' || github.event.inputs.setup_type == 'all' }}
    uses: ./.github/workflows/Docker_Setup.yml
    with:
      host: ${{ github.event.inputs.host }}
      environment: ${{ needs.dispatch.outputs.env }}
      runs_on: ${{ needs.dispatch.outputs.runner }}
    needs: dispatch

  call_docker_network:
    if: ${{ github.event.inputs.setup_type == 'docker network' || github.event.inputs.setup_type == 'all' }}
    uses: ./.github/workflows/Docker_Network_Setup.yml
    with:
      host: ${{ github.event.inputs.host }}
      environment: ${{ needs.dispatch.outputs.env }}
      runs_on: ${{ needs.dispatch.outputs.runner }}
    needs: dispatch

  call_OS_update:
    if: ${{ github.event.inputs.setup_type == 'host OS Update' || github.event.inputs.setup_type == 'all' }}
    uses: ./.github/workflows/OS_Update.yml
    with:
      host: ${{ github.event.inputs.host }}
      environment: ${{ needs.dispatch.outputs.env }}
      runs_on: ${{ needs.dispatch.outputs.runner }}
    needs: dispatch

  call_ssh_create_user:
    if: ${{ github.event.inputs.setup_type == 'ssh create-user' || github.event.inputs.setup_type == 'all' }}
    uses: ./.github/workflows/SSH_Setup.yml
    with:
      host: ${{ github.event.inputs.host }}
      environment: ${{ needs.dispatch.outputs.env }}
      runs_on: ${{ needs.dispatch.outputs.runner }}
      step: 'create-user'
    needs: dispatch

  call_ssh_setup_keys:
    if: ${{ github.event.inputs.setup_type == 'ssh setup-keys' }}
    uses: ./.github/workflows/SSH_Setup.yml
    with:
      host: ${{ github.event.inputs.host }}
      environment: ${{ needs.dispatch.outputs.env }}
      runs_on: ${{ needs.dispatch.outputs.runner }}
      step: 'setup-keys'
    needs: dispatch