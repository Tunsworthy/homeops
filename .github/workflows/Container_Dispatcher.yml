name: Container Dispatcher

on:
  push:
    paths:
      - 'docker/**'
  workflow_dispatch:
    inputs:
      container_folder:
        description: 'Container folder to deploy (e.g., housefinder)'
        required: true
        type: string
      branch:
        description: 'Branch to run against (optional)'
        required: false
        type: string
  repository_dispatch:
    types: [deploy-container]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-containers: ${{ steps.extract-folders.outputs.containers }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch || github.event_name == 'workflow_dispatch' && inputs.branch || github.ref }}

      - name: Get changed files (only on push)
        if: github.event_name == 'push'
        id: get-changes
        uses: tj-actions/changed-files@v44
        with:
          files: |
            docker/**

      - name: Extract container folder
        id: extract-folders
        run: |
          # Determine folder(s) based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            FOLDERS="${{ inputs.container_folder }}"
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            FOLDERS="${{ github.event.client_payload.folder || github.event.client_payload.container_folder }}"
          else
            # Get unique first-level folders under /docker from push diff
            FOLDERS=$(echo "${{ steps.get-changes.outputs.all_changed_files }}" \
              | tr ' ' '\n' \
              | awk -F'/' '{print $2}' \
              | sort -u \
              | paste -sd "," -)
          fi

          echo "Changed container folders: $FOLDERS"
          echo "containers=$FOLDERS" >> $GITHUB_OUTPUT
  read-config:
    needs: detect-changes
    runs-on: ubuntu-latest
    
    outputs:
      container-name: ${{ steps.read-config.outputs.name }}
      fqdn: ${{ steps.read-config.outputs.fqdn }}
      cert: ${{ steps.read-config.outputs.cert }}
      external: ${{ steps.read-config.outputs.external }}
      dedicated-ip: ${{ steps.read-config.outputs.dedicated_ip }}
      internet-access: ${{ steps.read-config.outputs.internet_access }}
      container-environment: ${{ steps.read-config.outputs.container_environment }}
      container-host: ${{ steps.read-config.outputs.container_host }}
      container-folder: ${{ steps.get-config.outputs.CONTAINER_FOLDER }}
      

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch || github.event_name == 'workflow_dispatch' && inputs.branch || github.ref }}

      - name: Get container configuration file
        id: get-config
        run: |
          CONTAINER="${{ needs.detect-changes.outputs.changed-containers }}"
          CONFIG_PATH="docker/$CONTAINER/configuration.yml"
          echo "CONFIG_PATH=$CONFIG_PATH" >> $GITHUB_ENV
          echo "CONTAINER_FOLDER=$CONTAINER" >> $GITHUB_OUTPUT

      - name: Read configuration.yml
        id: read-config
        run: |
          NAME=$(yq -r '.name' "$CONFIG_PATH")
          FQDN=$(yq -r '.fqdn' "$CONFIG_PATH")
          CERT=$(yq -r '.certificate' "$CONFIG_PATH")
          EXTERNAL=$(yq -r '.external_access' "$CONFIG_PATH")
          DEDICATED_IP=$(yq -r '.dedicated_ip' "$CONFIG_PATH")
          INTERNET_ACCESS=$(yq -r '.internet_access // false' "$CONFIG_PATH")
          CONTAINER_ENVIRONMENT=$(yq -r '.container_environment' "$CONFIG_PATH")
          CONTAINER_HOST=$(yq -r '.container_host' "$CONFIG_PATH")
          

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "fqdn=$FQDN" >> $GITHUB_OUTPUT
          echo "cert=$CERT" >> $GITHUB_OUTPUT
          echo "external=$EXTERNAL" >> $GITHUB_OUTPUT
          echo "dedicated_ip=$DEDICATED_IP" >> $GITHUB_OUTPUT
          echo "internet_access=$INTERNET_ACCESS" >> $GITHUB_OUTPUT
          echo "container_environment=$CONTAINER_ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "container_host=$CONTAINER_HOST" >> $GITHUB_OUTPUT
          

  create-cert:
    needs: 
      - read-config
    if: ${{ needs.read-config.outputs.cert == 'true' }}
    uses: ./.github/workflows/CertBot-New-Certs.yml
    with:
      environment: ${{ needs.read-config.outputs.container-environment}}
      domain_name: ${{ needs.read-config.outputs.fqdn }}
      runs_on: ${{ needs.read-config.outputs.container-host}}
    secrets: inherit

  allocate-ip:
    needs:
      - read-config
    if: ${{ needs.read-config.outputs.dedicated-ip == 'true' }}
    uses: ./.github/workflows/Container_Allocate-IP.yml
    with:
      environment: ${{ needs.read-config.outputs.container-environment}}
      container_name: ${{ needs.read-config.outputs.container-name }}
      docker_host: ${{ needs.read-config.outputs.container-host }}

  add-to-nat-allowlist:
    needs:
      - allocate-ip
      - read-config
    if: ${{ needs.read-config.outputs.internet-access == 'true' && needs.allocate-ip.result == 'success' }}
    uses: ./.github/workflows/Mikrotik_Add-IP-Allowlist.yml
    with:
      environment: ${{ needs.read-config.outputs.container-environment}}
      container_name: ${{ needs.read-config.outputs.container-name }}
      allocated_ip: ${{ needs.allocate-ip.outputs.ip_address }}
      docker_host: ${{ needs.read-config.outputs.container-host }}
    secrets: inherit
  
  create-internal-a-record:
      needs:
        - allocate-ip
        - read-config
      uses: ./.github/workflows/DNS_Internal_New_A_Recrod.yml
      
      with:
        environment: ${{ needs.read-config.outputs.container-environment}}
        docker_host: ${{ needs.read-config.outputs.container-host }}
        fqdn: ${{ needs.read-config.outputs.fqdn }}
        allocated_ip: ${{ needs.allocate-ip.outputs.ip_address || '' }}
      secrets: inherit

  deploy-container:
    if: ${{ always() && needs.read-config.result == 'success' }}
    needs:
      - read-config
      - allocate-ip
      - add-to-nat-allowlist
    uses: ./.github/workflows/Container_Deployment.yml
    with:
      environment: ${{ needs.read-config.outputs.container-environment }}
      container_name: ${{ needs.read-config.outputs.container-name }}
      allocated_ip: ${{ needs.allocate-ip.outputs.ip_address || '' }}
      docker_host: ${{ needs.read-config.outputs.container-host }}
      container_folder: ${{ needs.read-config.outputs.container-folder }}
      fqdn: ${{ needs.read-config.outputs.fqdn }}
    secrets: inherit
      
