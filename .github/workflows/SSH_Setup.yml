name: SSH Setup

on:
  workflow_call:
    inputs:
      host:
        required: true
        type: string
      environment:
        required: true
        type: string
      runs_on:
        required: true
        type: string
      step:
        required: true
        type: string
        description: 'Which step: create-user or setup-keys'

jobs:
  ssh-setup:
    runs-on: ${{ inputs.runs_on }}
    environment: ${{ inputs.environment }}

    env:
      BASE_DIR: 'infrastructure/host/ssh'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Ansible is installed
        run: |
          if ! command -v ansible >/dev/null 2>&1; then
            echo "Ansible not found. Installing..."
            sudo apt update
            sudo apt install -y ansible
          else
            echo "Ansible already installed."
          fi

      - name: Create Ansible inventory
        run: |
          cd $BASE_DIR
          echo "localhost ansible_connection=local" > inventory.ini

      - name: Run create-user playbook
        if: ${{ inputs.step == 'create-user' }}
        run: |
          cd $BASE_DIR
          echo "${{ secrets.SUDO }}" | sudo -S ansible-playbook create_admin_user.yml \
            -i inventory.ini

      - name: Run setup-keys playbook
        if: ${{ inputs.step == 'setup-keys' }}
        env:
          SSH_ADMIN_PRIVATE_KEY: ${{ secrets.SSH_ADMIN_PRIVATE_KEY }}
          SSH_ADMIN_PUBLIC_KEY: ${{ secrets.SSH_ADMIN_PUBLIC_KEY }}
        run: |
          cd $BASE_DIR
          
          echo "========================================="
          echo "DEBUG: SSH Keys Setup"
          echo "========================================="
          
          # Verify secrets are available
          echo "Private key length: $(echo -n "$SSH_ADMIN_PRIVATE_KEY" | wc -c) characters"
          echo "Public key length: $(echo -n "$SSH_ADMIN_PUBLIC_KEY" | wc -c) characters"
          echo ""
          
          if [ $(echo -n "$SSH_ADMIN_PRIVATE_KEY" | wc -c) -lt 100 ]; then
            echo "❌ ERROR: SSH_ADMIN_PRIVATE_KEY is too short or empty!"
            echo "First 50 chars: $(echo -n "$SSH_ADMIN_PRIVATE_KEY" | head -c 50)"
            exit 1
          fi
          
          if [ $(echo -n "$SSH_ADMIN_PUBLIC_KEY" | wc -c) -lt 30 ]; then
            echo "❌ ERROR: SSH_ADMIN_PUBLIC_KEY is too short or empty!"
            exit 1
          fi
          
          echo "✅ Secrets verified - proceeding with playbook"
          echo ""
          
          # Write keys to temporary files as backup
          echo "$SSH_ADMIN_PRIVATE_KEY" > /tmp/ssh_private_key
          echo "$SSH_ADMIN_PUBLIC_KEY" > /tmp/ssh_public_key
          
          echo "Temporary files written:"
          echo "  Private key: $(wc -c < /tmp/ssh_private_key) bytes"
          echo "  Public key: $(wc -c < /tmp/ssh_public_key) bytes"
          echo ""
          
          # Run playbook - pass both as env vars for Ansible lookup AND as files
          echo "${{ secrets.SUDO }}" | sudo -S \
            SSH_ADMIN_PRIVATE_KEY="$SSH_ADMIN_PRIVATE_KEY" \
            SSH_ADMIN_PUBLIC_KEY="$SSH_ADMIN_PUBLIC_KEY" \
            ansible-playbook setup_ssh_keys.yml \
            -i inventory.ini \
            -e "ssh_private_key_file=/tmp/ssh_private_key" \
            -e "ssh_public_key_file=/tmp/ssh_public_key"
          
          # Clean up temporary files
          rm -f /tmp/ssh_private_key /tmp/ssh_public_key

