name: OS Update

on:
  workflow_call:
    inputs:
      host:
        required: true
        type: string
      environment:
        required: true
        type: string
      runs_on:
        required: true
        type: string

jobs:
  update-os:
    # Run FROM the opposite host (cross-Pi update)
    runs-on: ${{ inputs.host == 'pi3' && 'pi4' || 'pi3' }}
    environment: ${{ inputs.environment }}

    env:
      BASE_DIR: 'infrastructure/host/os'
      ADMIN_USER: 'ansible-admin'

    steps:
      - name: Run OS Update
        run: |
          echo "Running OS Update for host: ${{ inputs.host }} from $(hostname)"
          echo "Using user: $ADMIN_USER"
          
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Ensure Ansible is Installed
        run: |
          if ! command -v ansible >/dev/null 2>&1; then
            echo "Ansible not found. Installing..."
            echo "${{ secrets.SUDO }}" | sudo -S apt update
            echo "${{ secrets.SUDO }}" | sudo -S apt install -y ansible
          else
            echo "Ansible already installed."
          fi

      - name: Create temporary inventory for target host
        run: |
          cd $BASE_DIR
          cat > inventory.ini <<EOF
          [${{ inputs.host }}]
          ${{ inputs.host == 'pi3' && '10.2.4.20' || '10.2.4.10' }} ansible_user=$ADMIN_USER
          EOF
          cat inventory.ini

      - name: Run OS Updater playbook (as ansible-admin user)
        run: |
          cd $BASE_DIR
          # Run as ansible-admin user which has passwordless sudo
          sudo -u $ADMIN_USER ansible-playbook OS_Updater.yml \
            -i inventory.ini \
            --limit ${{ inputs.host }}
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
