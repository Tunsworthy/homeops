name: Container Deployment

on:
  workflow_call:
    inputs:
      container_name:
        required: true
        type: string
      environment:
        required: true
        type: string
      allocated_ip:
        required: false
        type: string
      docker_host:
        required: false
        type: string
      container_folder:
        required: true
        type: string
      fqdn:
        required: false
        type: string
    secrets:
      SUDO:
        required: false
      PFX_PASSWORD:
        required: false
      CONTAINER_PASSWORD:
        required: false
      GOOGLEMAPS_API_KEY:
        required: false
      MQTT_HOST:
        required: false
      MQTT_CA_CERT_PATH:
        required: false
jobs:
  deploy-container:
    runs-on: ${{ inputs.docker_host }}
    environment: ${{ inputs.environment }}
    env:
      BASE_DIR: 'docker/${{ inputs.container_folder}}'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Ansible inventory
        run: |
          cd $BASE_DIR
          echo "localhost ansible_connection=local" > inventory.ini
      - name: Run Ansible playbook
        run: |
          cd $BASE_DIR
          # create a temporary extra-vars file with restricted permissions
          cat > extra_vars.yml <<EOF
          container_name: "${{ inputs.container_name }}"
          dedicated_ip: "${{ inputs.allocated_ip }}"
          fqdn: "${{ inputs.fqdn }}"
          pfx_password: "${{ secrets.PFX_PASSWORD }}"
          container_password: "${{ secrets.CONTAINER_PASSWORD }}"
          googlemaps_api_key: "${{ secrets.GOOGLEMAPS_API_KEY }}"
          googlemaps_map_id: "${{ secrets.GOOGLEMAPS_MAP_ID }}"
          mqtt_host: "${{ vars.MQTT_HOST }}"
          mqtt_ca_cert_path: "${{ vars.MQTT_CA_CERT_PATH }}"
          CLOUDFLARE_TOKEN: "${{ secrets.CLOUDFLARE_TOKEN }}"
          TELEGRAM_CHAT_ID: "${{ secrets.TELEGRAM_CHAT_ID }}"
          TELEGRAM_BOT_TOKEN: "${{ secrets.TELEGRAM_BOT_TOKEN }}"
          POSTGRES_URI: "${{ secrets.POSTGRES_URI }}"
          HTTPS_PORT: "${{ vars.HTTPS_PORT }}"
          SSL_KEY_PATH: "${{ vars.SSL_KEY_PATH }}"
          SSL_CERT_PATH: "${{ vars.SSL_CERT_PATH }}"
          BASE_URL: "${{ vars.BASE_URL }}"
          SESSION_SECRET: "${{ secrets.SESSION_SECRET }}"
          POSTGRES_PASSWORD_BABYTRACKER: "${{ secrets.POSTGRES_PASSWORD_BABYTRACKER }}"
          POSTGRES_USER_BABYTRACKER: "${{ vars.POSTGRES_USER_BABYTRACKER }}"
          POSTGRES_USER: "${{ secrets.POSTGRES_USER }}"
          POSTGRES_DB: "${{ secrets.POSTGRES_DB }}"
          POSTGRES_PASSWORD: "${{ secrets.POSTGRES_PASSWORD }}"

          EOF
          chmod 600 extra_vars.yml
          # run playbook using the vars file so sensitive values are not echoed in CLI args
          echo "${{ secrets.SUDO }}" | sudo -S ansible-playbook container_deploy.yml \
            -i inventory.ini \
            -e "@extra_vars.yml"
          # attempt secure deletion, fall back to rm
          shred -u extra_vars.yml || rm -f extra_vars.yml