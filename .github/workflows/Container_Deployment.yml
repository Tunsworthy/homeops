name: Container Deployment

on:
  workflow_call:
    inputs:
      container_name:
        required: true
        type: string
      environment:
        required: true
        type: string
      allocated_ip:
        required: false
        type: string
      docker_host:
        required: false
        type: string
      dedicated_ip:
        required: true
        type: boolean
      container_folder:
        required: true
        type: string
jobs:
  deploy-container:
    runs-on: ${{ inputs.docker_host }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set deployment variables
        id: set-vars
        run: |
          echo "CONTAINER_FOLDER=${{ inputs.container_folder}} >> $GITHUB_ENV"
          echo "CONTAINER_NAME=${{ inputs.container_name }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
          if [ "${{ inputs.dedicated_ip }}" == "true" ]; then
            echo "DEDICATED_IP=${{ inputs.allocated_ip }}" >> $GITHUB_ENV
          fi

      - name: Run container deployment playbook
        run: |
          ANSIBLE_PLAYBOOK_PATH="docker/${CONTAINER_FOLDER}/container_deploy.yml"
          if [ ! -f "$ANSIBLE_PLAYBOOK_PATH" ]; then
            echo "Error: Playbook $ANSIBLE_PLAYBOOK_PATH does not exist."
            exit 1
          fi

          ansible-playbook "$ANSIBLE_PLAYBOOK_PATH" \
            -e "container_name=$CONTAINER_NAME" \
            -e "environment=$ENVIRONMENT" \
            -e "dedicated_ip=$DEDICATED_IP"
